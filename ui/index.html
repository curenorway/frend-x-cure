<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migration Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      color: #111;
      font-size: 14px;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 240px;
      height: 100vh;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 20px 0;
      overflow-y: auto;
    }

    .logo {
      padding: 0 20px 16px;
      font-size: 16px;
      font-weight: 600;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 16px;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-label {
      padding: 0 20px;
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .nav-item {
      padding: 8px 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-item:hover { background: #f8f8f8; }
    .nav-item.active { background: #111; color: #fff; }

    .nav-badge {
      background: #f0f0f0;
      color: #666;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    .nav-item.active .nav-badge {
      background: #333;
      color: #fff;
    }

    .main {
      margin-left: 240px;
      min-height: 100vh;
    }

    .topbar {
      background: #fff;
      border-bottom: 1px solid #ddd;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: #f5f5f5;
      border-radius: 6px;
      padding: 6px 12px;
      width: 400px;
    }

    .search-box input {
      border: none;
      background: none;
      outline: none;
      width: 100%;
      font-size: 14px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
    }

    .btn {
      background: #111;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn:hover { background: #000; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-secondary {
      background: #fff;
      color: #111;
      border: 1px solid #ddd;
    }

    .btn-secondary:hover { background: #f8f8f8; }

    .content {
      padding: 24px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .page-subtitle {
      color: #666;
      font-size: 14px;
    }

    .filters {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 13px;
      color: #666;
    }

    select, input[type="checkbox"] {
      font-size: 13px;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 13px;
      color: #666;
    }

    .stat-change {
      font-size: 12px;
      margin-top: 4px;
    }

    .stat-change.success { color: #0a0; }
    .stat-change.warning { color: #f90; }

    .data-table {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #fafafa;
      border-bottom: 1px solid #ddd;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    tr:hover td {
      background: #fafafa;
    }

    .row-checkbox {
      width: 40px;
    }

    .row-status {
      width: 100px;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-published { background: #e6ffe6; color: #0a0; }
    .status-draft { background: #fff3e6; color: #f90; }
    .status-transformed { background: #e6f3ff; color: #09f; }
    .status-error { background: #ffe6e6; color: #f00; }

    .item-name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .item-meta {
      font-size: 12px;
      color: #999;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      background: none;
      border: 1px solid #ddd;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
    }

    .icon-btn:hover {
      background: #f5f5f5;
      border-color: #111;
    }

    .split-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .panel {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    .panel-header {
      background: #fafafa;
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      font-weight: 600;
      font-size: 13px;
    }

    .panel-body {
      padding: 16px;
      max-height: 600px;
      overflow-y: auto;
    }

    .field-row {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .field-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .field-value {
      font-size: 13px;
      word-break: break-word;
    }

    .field-value.empty {
      color: #ccc;
      font-style: italic;
    }

    .field-value pre {
      background: #f8f8f8;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      overflow-x: auto;
    }

    .mapping-arrow {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 20px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .progress-bar {
      background: #f0f0f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      background: #111;
      height: 100%;
      transition: width 0.3s;
    }

    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover { background: #f8f8f8; }
    .tab.active { border-bottom-color: #111; font-weight: 500; }

    .warning-box {
      background: #fff9e6;
      border: 1px solid #ffd700;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    .warning-box strong { color: #f90; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show { display: flex; }

    .modal-content {
      background: #fff;
      border-radius: 12px;
      max-width: 95%;
      width: 1200px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .close-btn {
      background: #f5f5f5;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
    }

    .close-btn:hover { background: #e0e0e0; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">Migration Tool</div>

    <div class="nav-section">
      <div class="nav-label">Overview</div>
      <div class="nav-item active" onclick="showOverview()">
        <span>Dashboard</span>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Content Types</div>
      <div id="nav-collections"></div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Tools</div>
      <div class="nav-item" onclick="showFieldMapping()">
        <span>Field Mapping</span>
      </div>
      <div class="nav-item" onclick="showValidation()">
        <span>Validation</span>
        <span class="nav-badge" id="validation-badge">0</span>
      </div>
      <div class="nav-item" onclick="showTransformStatus()">
        <span>Transform Status</span>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Webflow</div>
      <div class="nav-item" onclick="showWebflow()">
        <span>Collections</span>
        <span class="nav-badge" id="webflow-badge">New</span>
      </div>
      <div class="nav-item" onclick="showAIAnalysis()">
        <span>AI Analysis</span>
      </div>
      <div class="nav-item" onclick="showUploadCenter()">
        <span>Upload Center</span>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <div class="search-box">
        <input type="text" placeholder="Search content..." id="global-search" oninput="handleSearch(this.value)">
      </div>
      <div class="toolbar">
        <button class="btn btn-secondary" onclick="runDiscovery()">Refresh Data</button>
        <button class="btn" onclick="bulkTransform()">Transform Selected</button>
      </div>
    </div>

    <div class="content" id="main-content">
      <div class="empty-state">Loading...</div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Item Details</div>
        <button class="close-btn" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script>
    let discoveryData = null;
    let rawStories = [];
    let transformedData = {};
    let selectedItems = new Set();
    let currentFilter = 'all';
    let searchQuery = '';

    async function init() {
      try {
        const [discRes, storiesRes] = await Promise.all([
          fetch('/api/discovery'),
          fetch('/reports/raw-stories.json')
        ]);

        discoveryData = await discRes.json();
        rawStories = await storiesRes.json();

        await loadTransformedData();
        renderNavCollections();
        showOverview();
      } catch (e) {
        document.getElementById('main-content').innerHTML = `
          <div class="empty-state">
            <h3>No data found</h3>
            <p>Run discovery first: npm run discover</p>
          </div>
        `;
      }
    }

    async function loadTransformedData() {
      const types = ['team-members', 'articles', 'videos', 'projects'];
      for (const type of types) {
        try {
          const res = await fetch(`/api/transformed/${type}`);
          if (res.ok) {
            transformedData[type] = await res.json();
          }
        } catch (e) {}
      }
    }

    function renderNavCollections() {
      const contentTypes = discoveryData.stories?.analysis?.byContentType || {};
      const sorted = Object.entries(contentTypes).sort((a,b) => b[1] - a[1]);

      const nav = document.getElementById('nav-collections');
      nav.innerHTML = sorted.map(([type, count]) => `
        <div class="nav-item" onclick="showCollection('${type}')">
          <span>${type}</span>
          <span class="nav-badge">${count}</span>
        </div>
      `).join('');
    }

    function showOverview() {
      setActiveNav('Dashboard');
      const contentTypes = discoveryData.stories?.analysis?.byContentType || {};
      const published = discoveryData.stories?.analysis?.byPublished?.published || 0;
      const total = discoveryData.stories?.total || 0;

      const transformedCount = Object.values(transformedData).reduce((sum, t) => sum + (t.successful || 0), 0);
      const failedCount = Object.values(transformedData).reduce((sum, t) => sum + (t.failed || 0), 0);

      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">Migration Overview</div>
          <div class="page-subtitle">Storyblok content analysis and transformation status</div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value">${total}</div>
            <div class="stat-label">Total Content Items</div>
            <div class="stat-change success">${published} published</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${Object.keys(contentTypes).length}</div>
            <div class="stat-label">Content Types</div>
            <div class="stat-change">${discoveryData.components?.total || 0} components</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${transformedCount}</div>
            <div class="stat-label">Items Transformed</div>
            <div class="stat-change ${failedCount > 0 ? 'warning' : 'success'}">${failedCount} failed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${Math.round((transformedCount / total) * 100)}%</div>
            <div class="stat-label">Progress</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(transformedCount / total) * 100}%"></div>
            </div>
          </div>
        </div>

        ${failedCount > 0 ? `
          <div class="warning-box">
            <strong>⚠ ${failedCount} items failed transformation</strong> - Review validation errors
          </div>
        ` : ''}

        <div class="tabs">
          <div class="tab active" onclick="showOverviewTab('types')">By Content Type</div>
          <div class="tab" onclick="showOverviewTab('status')">By Status</div>
          <div class="tab" onclick="showOverviewTab('recent')">Recent Activity</div>
        </div>

        <div id="overview-tab-content">
          ${renderContentTypesTable()}
        </div>
      `;
    }

    function renderContentTypesTable() {
      const contentTypes = discoveryData.stories?.analysis?.byContentType || {};
      const sorted = Object.entries(contentTypes).sort((a,b) => b[1] - a[1]);

      return `
        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th>Content Type</th>
                <th>Count</th>
                <th>Transformed</th>
                <th>Progress</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(([type, count]) => {
                const typeKey = getTransformKey(type);
                const transformed = transformedData[typeKey]?.successful || 0;
                const failed = transformedData[typeKey]?.failed || 0;
                const percent = count > 0 ? Math.round((transformed / count) * 100) : 0;

                return `
                  <tr>
                    <td>
                      <div class="item-name">${type}</div>
                      <div class="item-meta">${count} total items</div>
                    </td>
                    <td>${count}</td>
                    <td>
                      ${transformed > 0 ? `<span class="status-badge status-transformed">${transformed} done</span>` : '—'}
                      ${failed > 0 ? `<span class="status-badge status-error">${failed} failed</span>` : ''}
                    </td>
                    <td>
                      <div>${percent}%</div>
                      <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                      </div>
                    </td>
                    <td>
                      <div class="actions">
                        <button class="icon-btn" onclick="showCollection('${type}')">View</button>
                        <button class="icon-btn" onclick="transformCollection('${type}')">Transform</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function showCollection(type) {
      setActiveNav(type);
      const items = rawStories.filter(s => s.content_type === type);
      const filtered = filterItems(items);

      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">${type}</div>
          <div class="page-subtitle">${filtered.length} items ${filtered.length !== items.length ? `(${items.length} total)` : ''}</div>
        </div>

        <div class="filters">
          <div class="filter-group">
            <input type="checkbox" id="select-all" onchange="toggleSelectAll(this.checked, '${type}')">
            <label class="filter-label" for="select-all">Select All</label>
          </div>
          <div class="filter-group">
            <label class="filter-label">Status:</label>
            <select onchange="filterByStatus(this.value, '${type}')">
              <option value="all">All</option>
              <option value="published">Published</option>
              <option value="draft">Draft</option>
              <option value="transformed">Transformed</option>
              <option value="not-transformed">Not Transformed</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" style="margin-left: auto">${selectedItems.size} selected</label>
          </div>
          <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
          <button class="btn" onclick="transformSelected()">Transform Selected</button>
        </div>

        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th class="row-checkbox"></th>
                <th>Name</th>
                <th>Slug</th>
                <th class="row-status">Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map(item => `
                <tr>
                  <td class="row-checkbox">
                    <input type="checkbox"
                      ${selectedItems.has(item.id) ? 'checked' : ''}
                      onchange="toggleSelection(${item.id}, this.checked)">
                  </td>
                  <td>
                    <div class="item-name">${item.name}</div>
                    <div class="item-meta">ID: ${item.id}</div>
                  </td>
                  <td>${item.slug}</td>
                  <td>
                    <span class="status-badge ${item.published_at ? 'status-published' : 'status-draft'}">
                      ${item.published_at ? 'Published' : 'Draft'}
                    </span>
                  </td>
                  <td>
                    <div class="actions">
                      <button class="icon-btn" onclick="viewItem(${item.id})">View</button>
                      <button class="icon-btn" onclick="compareItem(${item.id})">Compare</button>
                      <button class="icon-btn" onclick="transformSingle(${item.id})">Transform</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function viewItem(itemId) {
      const item = rawStories.find(s => s.id === itemId);
      if (!item) return;

      document.getElementById('modal-title').textContent = item.name;
      document.getElementById('modal-body').innerHTML = `
        <div class="panel">
          <div class="panel-header">Original Content (Storyblok)</div>
          <div class="panel-body">
            ${renderFieldList(item.content)}
          </div>
        </div>
      `;

      document.getElementById('modal').classList.add('show');
    }

    function compareItem(itemId) {
      const item = rawStories.find(s => s.id === itemId);
      if (!item) return;

      document.getElementById('modal-title').textContent = `Compare: ${item.name}`;
      document.getElementById('modal-body').innerHTML = `
        <div class="split-view">
          <div class="panel">
            <div class="panel-header">Original (Storyblok)</div>
            <div class="panel-body">
              ${renderFieldList(item.content)}
            </div>
          </div>
          <div class="panel">
            <div class="panel-header">Transformed (Webflow)</div>
            <div class="panel-body">
              <div class="empty-state">
                <p>Transform this item to see output</p>
                <button class="btn" onclick="transformSingle(${itemId}); setTimeout(() => compareItem(${itemId}), 1000)">Transform Now</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal').classList.add('show');
    }

    function renderFieldList(content) {
      if (!content || typeof content !== 'object') return '<p class="empty-state">No content</p>';

      return Object.entries(content).map(([key, value]) => {
        let displayValue = value;

        if (value === null || value === undefined || value === '') {
          displayValue = '<span class="empty">(empty)</span>';
        } else if (typeof value === 'object') {
          displayValue = `<pre>${JSON.stringify(value, null, 2)}</pre>`;
        } else if (typeof value === 'string' && value.length > 200) {
          displayValue = value.substring(0, 200) + '...';
        }

        return `
          <div class="field-row">
            <div class="field-label">${key}</div>
            <div class="field-value">${displayValue}</div>
          </div>
        `;
      }).join('');
    }

    function showFieldMapping() {
      setActiveNav('Field Mapping');
      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">Field Mapping</div>
          <div class="page-subtitle">Storyblok → Webflow field transformations</div>
        </div>

        <div class="panel">
          <div class="panel-header">Team Members (Person → Team Members)</div>
          <div class="panel-body">
            ${renderMappingTable([
              { from: 'name', to: 'name', type: 'Plain Text', notes: 'Direct mapping' },
              { from: 'slug', to: 'slug', type: 'Plain Text', notes: 'Sanitized' },
              { from: 'role', to: 'role', type: 'Plain Text', notes: '' },
              { from: 'email', to: 'email', type: 'Email', notes: '' },
              { from: 'phone', to: 'phone', type: 'Phone', notes: '' },
              { from: 'image', to: 'profileImage', type: 'Image', notes: 'Asset URL resolution' },
              { from: 'altImage', to: 'altImage', type: 'Image', notes: 'Optional' },
              { from: 'metaFields.title', to: 'seoTitle', type: 'Plain Text', notes: 'SEO metadata' },
              { from: 'metaFields.description', to: 'seoDescription', type: 'Plain Text', notes: 'SEO metadata' }
            ])}
          </div>
        </div>
      `;
    }

    function renderMappingTable(mappings) {
      return `
        <table>
          <thead>
            <tr>
              <th>Storyblok Field</th>
              <th>→</th>
              <th>Webflow Field</th>
              <th>Type</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            ${mappings.map(m => `
              <tr>
                <td><code>${m.from}</code></td>
                <td style="text-align: center">→</td>
                <td><code>${m.to}</code></td>
                <td>${m.type}</td>
                <td>${m.notes || '—'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function showValidation() {
      setActiveNav('Validation');
      // TODO: Run validation checks
      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">Validation</div>
          <div class="page-subtitle">Content validation and error checking</div>
        </div>
        <div class="empty-state">
          <p>Validation checks coming soon</p>
        </div>
      `;
    }

    function showTransformStatus() {
      setActiveNav('Transform Status');
      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">Transform Status</div>
          <div class="page-subtitle">Transformation progress and results</div>
        </div>
        <div class="empty-state">
          <p>Transform status tracking coming soon</p>
        </div>
      `;
    }

    // Webflow Integration Functions
    let webflowCollections = [];
    let aiSuggestions = {};

    async function showWebflow() {
      setActiveNav('Collections');

      // Load Webflow collections
      try {
        const res = await fetch('/api/webflow/collections');
        if (res.ok) {
          webflowCollections = await res.json();
        }
      } catch (e) {
        console.error('Failed to load Webflow collections:', e);
      }

      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">Webflow Collections</div>
          <div class="page-subtitle">Manage your Webflow CMS collections and field mappings</div>
        </div>

        ${webflowCollections.length === 0 ? `
          <div class="warning-box">
            <strong>No Webflow Collections Found</strong> - Use AI Analysis to generate collection schemas based on your transformed data
          </div>
        ` : ''}

        <div class="tabs">
          <div class="tab active" onclick="showWebflowTab('existing')">Existing Collections</div>
          <div class="tab" onclick="showWebflowTab('create')">Create New</div>
          <div class="tab" onclick="showWebflowTab('mapping')">Field Mapping</div>
        </div>

        <div id="webflow-tab-content">
          ${renderWebflowCollections()}
        </div>
      `;
    }

    function renderWebflowCollections() {
      if (webflowCollections.length === 0) {
        return `
          <div class="empty-state">
            <h3>No Collections Found</h3>
            <p>You haven't created any Webflow collections yet.</p>
            <button class="btn" onclick="showAIAnalysis()">Use AI to Generate Collections</button>
          </div>
        `;
      }

      return `
        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th>Collection Name</th>
                <th>Slug</th>
                <th>Items</th>
                <th>Fields</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${webflowCollections.map(col => `
                <tr>
                  <td>
                    <div class="item-name">${col.name}</div>
                    <div class="item-meta">ID: ${col._id}</div>
                  </td>
                  <td>${col.slug}</td>
                  <td>${col.count || 0}</td>
                  <td>${col.fields?.length || 0} fields</td>
                  <td>
                    <div class="actions">
                      <button class="icon-btn" onclick="viewCollection('${col._id}')">View</button>
                      <button class="icon-btn" onclick="uploadToCollection('${col._id}')">Upload</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    async function showAIAnalysis() {
      setActiveNav('AI Analysis');

      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">AI-Powered Collection Analysis</div>
          <div class="page-subtitle">Let AI analyze your data and suggest optimal Webflow collection schemas</div>
        </div>

        <div class="warning-box">
          <strong>How it works:</strong> Claude AI will analyze your transformed data and suggest the best Webflow collection structure, including field types, validations, and relationships.
        </div>

        <div class="stats-row">
          ${['videos', 'projects', 'articles', 'news', 'team-members'].map(type => {
            const data = transformedData[type];
            const count = data?.successful || 0;
            return `
              <div class="stat-card" style="cursor: pointer" onclick="analyzeContentType('${type}')">
                <div class="stat-value">${count}</div>
                <div class="stat-label">${type.replace('-', ' ')}</div>
                <div class="stat-change ${count > 0 ? 'success' : ''}">
                  ${count > 0 ? 'Click to analyze' : 'Transform first'}
                </div>
              </div>
            `;
          }).join('')}
        </div>

        ${Object.keys(aiSuggestions).length > 0 ? `
          <h3 style="margin: 24px 0 16px">AI Suggestions</h3>
          ${renderAISuggestions()}
        ` : ''}
      `;
    }

    async function analyzeContentType(type) {
      const data = transformedData[type];
      if (!data || data.successful === 0) {
        alert('Please transform this content type first');
        return;
      }

      document.getElementById('main-content').innerHTML += `
        <div class="panel" id="ai-analysis-${type}">
          <div class="panel-header">Analyzing ${type}...</div>
          <div class="panel-body">
            <div class="empty-state">
              <div class="progress-bar">
                <div class="progress-fill" style="width: 50%; animation: pulse 1s infinite"></div>
              </div>
              <p>AI is analyzing your data structure...</p>
            </div>
          </div>
        </div>
      `;

      try {
        const res = await fetch('/api/webflow/ai-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contentType: type })
        });

        if (res.ok) {
          const suggestions = await res.json();
          aiSuggestions[type] = suggestions[type];

          // Update the panel with results
          document.getElementById(`ai-analysis-${type}`).innerHTML = `
            <div class="panel-header">${type} - AI Analysis Complete</div>
            <div class="panel-body">
              ${renderCollectionSchema(suggestions[type])}
            </div>
          `;
        }
      } catch (e) {
        console.error('AI analysis failed:', e);
        document.getElementById(`ai-analysis-${type}`).innerHTML = `
          <div class="panel-header">${type} - Analysis Failed</div>
          <div class="panel-body">
            <div class="warning-box">
              <strong>Error:</strong> ${e.message}
            </div>
          </div>
        `;
      }
    }

    function renderCollectionSchema(suggestion) {
      if (!suggestion || !suggestion.schema) return '<p>No schema generated</p>';

      const { schema, statistics, insights } = suggestion;

      return `
        <div style="margin-bottom: 20px">
          <h4>Collection Details</h4>
          <div class="field-row">
            <div class="field-label">Name:</div>
            <div class="field-value">${schema.collection.name}</div>
          </div>
          <div class="field-row">
            <div class="field-label">Slug:</div>
            <div class="field-value">${schema.collection.slug}</div>
          </div>
          <div class="field-row">
            <div class="field-label">Items:</div>
            <div class="field-value">${statistics.totalItems} items ready</div>
          </div>
        </div>

        <h4>Suggested Fields (${schema.fields.length})</h4>
        <table style="width: 100%; margin: 16px 0">
          <thead>
            <tr>
              <th>Field Name</th>
              <th>Type</th>
              <th>Required</th>
              <th>Help Text</th>
            </tr>
          </thead>
          <tbody>
            ${schema.fields.map(field => `
              <tr>
                <td><strong>${field.name}</strong><br><small>${field.slug}</small></td>
                <td><span class="status-badge">${field.type}</span></td>
                <td>${field.required ? '✓' : ''}</td>
                <td><small>${field.helpText || '—'}</small></td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        ${insights && insights.length > 0 ? `
          <h4>Insights</h4>
          ${insights.map(i => `
            <div class="warning-box" style="margin: 8px 0">
              <strong>${i.type}:</strong> ${i.message}
            </div>
          `).join('')}
        ` : ''}

        <div style="margin-top: 20px; display: flex; gap: 8px">
          <button class="btn" onclick="createWebflowCollection('${schema.collection.slug}')">
            Create Collection in Webflow
          </button>
          <button class="btn btn-secondary" onclick="downloadSchema('${schema.collection.slug}')">
            Download Schema JSON
          </button>
        </div>
      `;
    }

    async function showUploadCenter() {
      setActiveNav('Upload Center');

      document.getElementById('main-content').innerHTML = `
        <div class="page-header">
          <div class="page-title">Upload Center</div>
          <div class="page-subtitle">Upload transformed content to Webflow CMS</div>
        </div>

        <div class="warning-box">
          <strong>Dry Run Mode:</strong> Test uploads without actually creating items in Webflow
        </div>

        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">Content Type:</label>
            <select id="upload-content-type">
              <option value="">Select content type...</option>
              ${Object.keys(transformedData).map(type => `
                <option value="${type}">${type}</option>
              `).join('')}
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Collection:</label>
            <select id="upload-collection">
              <option value="">Select Webflow collection...</option>
              ${webflowCollections.map(col => `
                <option value="${col._id}">${col.name}</option>
              `).join('')}
            </select>
          </div>
          <div class="filter-group">
            <input type="checkbox" id="dry-run" checked>
            <label for="dry-run">Dry Run (Validate Only)</label>
          </div>
          <button class="btn" onclick="startUpload()">Start Upload</button>
        </div>

        <div id="upload-status"></div>
        <div id="upload-progress"></div>
        <div id="upload-results"></div>
      `;
    }

    async function startUpload() {
      const contentType = document.getElementById('upload-content-type').value;
      const collectionId = document.getElementById('upload-collection').value;
      const dryRun = document.getElementById('dry-run').checked;

      if (!contentType || !collectionId) {
        alert('Please select both content type and collection');
        return;
      }

      const data = transformedData[contentType];
      if (!data || data.successful === 0) {
        alert('No transformed data available for this content type');
        return;
      }

      document.getElementById('upload-status').innerHTML = `
        <div class="panel">
          <div class="panel-header">Upload Progress</div>
          <div class="panel-body">
            <div class="field-row">
              <div class="field-label">Mode:</div>
              <div class="field-value">${dryRun ? 'Dry Run (Validation Only)' : 'Live Upload'}</div>
            </div>
            <div class="field-row">
              <div class="field-label">Items:</div>
              <div class="field-value">0 / ${data.successful}</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="upload-progress-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      `;

      try {
        const res = await fetch('/api/webflow/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contentType,
            collectionId,
            dryRun,
            limit: 10 // Start with 10 items for testing
          })
        });

        if (res.ok) {
          const results = await res.json();

          document.getElementById('upload-results').innerHTML = `
            <div class="panel">
              <div class="panel-header">Upload Results</div>
              <div class="panel-body">
                <div class="stats-row">
                  <div class="stat-card">
                    <div class="stat-value">${results.successful}</div>
                    <div class="stat-label">Successful</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">${results.failed}</div>
                    <div class="stat-label">Failed</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">${results.total}</div>
                    <div class="stat-label">Total</div>
                  </div>
                </div>

                ${results.errors && results.errors.length > 0 ? `
                  <h4>Errors</h4>
                  ${results.errors.map(err => `
                    <div class="warning-box">
                      <strong>Item:</strong> ${err.item.name}<br>
                      <strong>Error:</strong> ${err.error}
                    </div>
                  `).join('')}
                ` : ''}

                ${!dryRun && results.successful > 0 ? `
                  <button class="btn" style="margin-top: 16px" onclick="publishItems('${collectionId}', ${JSON.stringify(results.createdItems.map(i => i._id))})">
                    Publish Items
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }
      } catch (e) {
        console.error('Upload failed:', e);
        document.getElementById('upload-results').innerHTML = `
          <div class="warning-box">
            <strong>Upload Failed:</strong> ${e.message}
          </div>
        `;
      }
    }

    async function createWebflowCollection(slug) {
      const suggestion = Object.values(aiSuggestions).find(s => s?.schema?.collection?.slug === slug);
      if (!suggestion) {
        alert('Schema not found');
        return;
      }

      if (!confirm(`Create collection "${suggestion.schema.collection.name}" in Webflow?`)) return;

      try {
        const res = await fetch('/api/webflow/create-collection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ schema: suggestion.schema })
        });

        if (res.ok) {
          alert('Collection created successfully!');
          showWebflow(); // Refresh collections view
        } else {
          const error = await res.text();
          alert(`Failed to create collection: ${error}`);
        }
      } catch (e) {
        alert(`Error: ${e.message}`);
      }
    }

    function downloadSchema(slug) {
      const suggestion = Object.values(aiSuggestions).find(s => s?.schema?.collection?.slug === slug);
      if (!suggestion) return;

      const blob = new Blob([JSON.stringify(suggestion, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${slug}-schema.json`;
      a.click();
    }

    async function publishItems(collectionId, itemIds) {
      if (!confirm(`Publish ${itemIds.length} items to production?`)) return;

      try {
        const res = await fetch('/api/webflow/publish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ collectionId, itemIds })
        });

        if (res.ok) {
          alert('Items published successfully!');
        } else {
          alert('Failed to publish items');
        }
      } catch (e) {
        alert(`Error: ${e.message}`);
      }
    }

    function showWebflowTab(tab) {
      document.querySelectorAll('.tab').forEach(el => {
        el.classList.toggle('active', el.textContent.toLowerCase().includes(tab.substring(0, 4)));
      });

      switch(tab) {
        case 'existing':
          document.getElementById('webflow-tab-content').innerHTML = renderWebflowCollections();
          break;
        case 'create':
          document.getElementById('webflow-tab-content').innerHTML = renderCreateCollection();
          break;
        case 'mapping':
          document.getElementById('webflow-tab-content').innerHTML = renderFieldMappingConfig();
          break;
      }
    }

    function renderCreateCollection() {
      return `
        <div class="panel">
          <div class="panel-header">Create New Collection</div>
          <div class="panel-body">
            <p>Use AI Analysis to automatically generate collection schemas based on your transformed data.</p>
            <button class="btn" onclick="showAIAnalysis()">Go to AI Analysis</button>
          </div>
        </div>
      `;
    }

    function renderFieldMappingConfig() {
      return `
        <div class="panel">
          <div class="panel-header">Configure Field Mappings</div>
          <div class="panel-body">
            <p>Field mappings are automatically configured based on your data structure.</p>
            <p>The AI Analysis tool will suggest optimal field mappings for each content type.</p>
          </div>
        </div>
      `;
    }

    function filterItems(items) {
      let filtered = items;

      if (searchQuery) {
        filtered = filtered.filter(item =>
          item.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          item.slug.toLowerCase().includes(searchQuery.toLowerCase())
        );
      }

      if (currentFilter === 'published') {
        filtered = filtered.filter(item => item.published_at);
      } else if (currentFilter === 'draft') {
        filtered = filtered.filter(item => !item.published_at);
      }

      return filtered;
    }

    function handleSearch(query) {
      searchQuery = query;
      // Re-render current view
    }

    function filterByStatus(status, type) {
      currentFilter = status;
      showCollection(type);
    }

    function toggleSelection(itemId, checked) {
      if (checked) {
        selectedItems.add(itemId);
      } else {
        selectedItems.delete(itemId);
      }
    }

    function toggleSelectAll(checked, type) {
      const items = rawStories.filter(s => s.content_type === type);
      items.forEach(item => {
        if (checked) {
          selectedItems.add(item.id);
        } else {
          selectedItems.delete(item.id);
        }
      });
      showCollection(type);
    }

    function clearSelection() {
      selectedItems.clear();
      showCollection(currentCollection);
    }

    async function transformSelected() {
      if (selectedItems.size === 0) {
        alert('No items selected');
        return;
      }
      alert(`Transforming ${selectedItems.size} items... (functionality coming soon)`);
    }

    async function transformSingle(itemId) {
      alert(`Transform item ${itemId} (functionality coming soon)`);
    }

    async function transformCollection(type) {
      const typeKey = getTransformKey(type);
      try {
        const res = await fetch(`/api/transform/${typeKey}`, { method: 'POST' });
        if (res.ok) {
          await loadTransformedData();
          showOverview();
        }
      } catch (e) {
        alert(`Error: ${e.message}`);
      }
    }

    async function bulkTransform() {
      alert('Bulk transform (functionality coming soon)');
    }

    async function runDiscovery() {
      if (!confirm('Run discovery? This will take ~30 seconds')) return;
      try {
        await fetch('/api/run-discovery', { method: 'POST' });
        setTimeout(() => location.reload(), 2000);
      } catch (e) {
        alert(`Error: ${e.message}`);
      }
    }

    function getTransformKey(type) {
      const map = {
        'Person': 'team-members',
        'Article': 'articles',
        'Video': 'videos',
        'project': 'projects'
      };
      return map[type] || type.toLowerCase().replace(/\s+/g, '-');
    }

    function setActiveNav(name) {
      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.toggle('active', el.textContent.trim().startsWith(name));
      });
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    // Close modal on outside click
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });

    // Initialize
    init();
  </script>
</body>
</html>
